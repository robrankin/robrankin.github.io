<!DOCTYPE html>


<html lang="en-us" data-theme="">
<head>
    
        
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer-when-downgrade">

<title>Kibaba Authentication using OAuth2 Proxy in Kubernetes - Home</title>
<meta name="description" content="">

<link rel="icon" type="image/x-icon" href="favicon.ico">
<link rel="apple-touch-icon-precomposed" href="favicon.png">



    





    
    
    

    
        <link rel="stylesheet" href="/css/style.4622e864a3694db065c6fdee8f297dc58db0efa3a22c934e5b0863569db3def4.css" integrity="sha256-RiLoZKNpTbBlxv3ujyl9xY2w76OiLJNOWwhjVp2z3vQ=">
    





<meta property="og:title" content="Kibaba Authentication using OAuth2 Proxy in Kubernetes" />
<meta property="og:description" content="NOTE: There appears to be a bug with Kibanas impersonation features, and SIEM detection rules (and possibly elswhere): https://github.com/elastic/kibana/issues/74828
 Recently I had reason to want to integrate Kibana with Azure Active Directory for authentication. This might be easily possible if you have a commercial license with Elastic, but this wasn&rsquo;t the case this time.
After a little bit of research I found this article, from February 2017:
User Impersonation with X-Pack: Integrating Third Party Auth with Kibana" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/kibaba-oauth-kubernetes/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-08-06T12:34:50+01:00" />
<meta property="article:modified_time" content="2020-08-06T12:34:50+01:00" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kibaba Authentication using OAuth2 Proxy in Kubernetes"/>
<meta name="twitter:description" content="NOTE: There appears to be a bug with Kibanas impersonation features, and SIEM detection rules (and possibly elswhere): https://github.com/elastic/kibana/issues/74828
 Recently I had reason to want to integrate Kibana with Azure Active Directory for authentication. This might be easily possible if you have a commercial license with Elastic, but this wasn&rsquo;t the case this time.
After a little bit of research I found this article, from February 2017:
User Impersonation with X-Pack: Integrating Third Party Auth with Kibana"/>



    
        <link rel="webmention" href="https://webmention.io/hugo-theme-anubis/webmention" />
        
            <link rel="pingback" href="https://webmention.io/hugo-theme-anubis/xmlrpc" />
        
    
    
        <link rel="webmention" href="https://yourdomain.com/webemntions/receive" />
    






    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MYJYFQEBD7"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-MYJYFQEBD7', { 'anonymize_ip': false });
}
</script>





    
</head>
<body>
    <a class="skip-main" href="#main">Skip to main content</a>
    <div class="container">
        <header class="common-header"> 
            
                <div class="header-top">
    <h1 class="site-title">
        <a href="/">Home</a>
    </h1>
    <ul class="social-icons">


    
        
        
        <li>
            <a href="https://github.com/robrankin" title="Github" rel="me">
            <span class="inline-svg" >
    



    
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!-- Font Awesome Free 5.15.3 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

</span>

            </a>
        </li>
    

    
        
        
        <li>
            <a href="https://twitter.com/mahhyzero" title="Twitter" rel="me">
            <span class="inline-svg" >
    



    
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.3 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>

</span>

            </a>
        </li>
    

    
        
        
        <li>
            <a href="https://www.linkedin.com/in/rob-rankin-7312234" title="Linkedin" rel="me">
            <span class="inline-svg" >
    



    
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.3 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

</span>

            </a>
        </li>
    

    
        
        
        <li>
            <a href="mailto:blog@undertow.ca" title="Email" rel="me">
            <span class="inline-svg" >
    



    
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.3 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path fill="currentColor" d="M464 64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 400V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V400H48z"/></svg>

</span>

            </a>
        </li>
    

</ul>

</div>

    <nav></nav>




            
        </header>
        <main id="main" tabindex="-1"> 
            
    
    
    <article class="post h-entry">
        <header class="post-header">
            <h1 class="p-name post-title">Kibaba Authentication using OAuth2 Proxy in Kubernetes</h1>

            
        </header>
        <div class="content e-content">
            <blockquote>
<p>NOTE: There appears to be a bug with Kibanas impersonation features, and SIEM detection rules (and possibly elswhere): <a href="https://github.com/elastic/kibana/issues/74828">https://github.com/elastic/kibana/issues/74828</a></p>
</blockquote>
<p>Recently I had reason to want to integrate Kibana with Azure Active Directory for authentication.  This might be easily possible if you have a commercial license with Elastic, but this wasn&rsquo;t the case this time.</p>
<p>After a little bit of research I found this article, from February 2017:</p>
<p><a href="https://www.elastic.co/blog/user-impersonation-with-x-pack-integrating-third-party-auth-with-kibana">User Impersonation with X-Pack: Integrating Third Party Auth with Kibana</a></p>
<p>Obviously it&rsquo;s starting to get a little long in the tooth, but as long as user impersonation is still supported, the basic outline should work.</p>
<p>The main trouble with the article is the specific setup used, illustrated by the image:</p>
<p><img src="/images/oauth_kibana_1.png" alt=""></p>
<p>Problems:</p>
<ol>
<li><code>oauth2_proxy</code> terminating the browser connection (and possibly TLS)</li>
<li><code>oauth2_proxy</code> running in reverse proxy mode</li>
</ol>
<p>This is more what I was looking for:</p>
<p><img src="/images/Kibana_Oauth2_Kubernetes.jpg" alt=""></p>
<p>For this deployment, Kibana and OAuth2 Proxy would be deployed on Kubernetes, and would be made available behind the standard k8s ingress controller, <a href="https://github.com/kubernetes/ingress-nginx">Ingress Nginx</a>.</p>
<p>Therefore the browser connection would be terminated on the Ingress Nginx controller.  As a side note, this takes advantage of <code>cert-manager</code> to automatically provision and manage TLS certificates, very handy.</p>
<p>I also didn&rsquo;t really want to run <code>oauth2_proxy</code> in full reverse proxy mode, as that&rsquo;s the job of the ingress controller.  Don&rsquo;t need more proxies involved here.</p>
<p>Luckily, nginx has just the feature for this, the <a href="http://nginx.org/en/docs/http/ngx_http_auth_request_module.html">ngx_http_auth_request</a> module.  As per the documentation:</p>
<blockquote>
<p>The ngx_http_auth_request_module module (1.5.4+) implements client authorization based on the result of a subrequest. If the subrequest returns a 2xx response code, the access is allowed. If it returns 401 or 403, the access is denied with the corresponding error code. Any other response code returned by the subrequest is considered an error.</p>
</blockquote>
<p>So, in theory as long as a header called <code>es-security-runas-user</code> can be passed to Kibana, with a value of a valid username, and be authrorized to do so by using HTTP Basic auth as a user with rights to impersonate another use, we&rsquo;re good to go.</p>
<p>The short form is:</p>
<ul>
<li>A &ldquo;Service Account&rdquo; is required in Kibana, with a Role that allows it to impersonate users.</li>
<li>User accounts in Kibana for your users, with whatever roles they require.</li>
<li>All requests from the ingress controller to Kibana must have 2 headers:
<ul>
<li>Basic Auth header for the &ldquo;Service Account&rdquo;</li>
<li>An <code>es-security-runas-user</code> with a valid username created in Kibana.</li>
</ul>
</li>
</ul>
<p>So let&rsquo;s get down to it, then, here&rsquo;s the specific configurations required to make this work!</p>
<p>These will be a mix between Helm chart values, and some &ldquo;raw-ish&rdquo; Kube configs (deployed using the <code>raw</code> Helm chart).</p>
<p>OAuth2 Proxy Helm values.yaml</p>
<pre><code>image:
  repository: &quot;quay.io/pusher/oauth2_proxy&quot;
  tag: &quot;v6.0.0&quot;
  pullPolicy: &quot;IfNotPresent&quot;

extraArgs:
  provider: 'azure'
  email-domain: '&lt;your email domain here&gt;'
  azure-tenant: '&lt;your tenant id here&gt;'
  client-id: '&lt;your client id here&gt;'
  client-secret: '&lt;your client secret here&gt;'

  redirect-url: https://kibana.example.com/oauth2/callback

  cookie-secret: '&lt;cookie secret&gt;'
  cookie-domain: &lt;cookie domain&gt;
  cookie-samesite: none

  set-xauthrequest: true

  session-store-type: redis
  redis-connection-url: 'redis://redis-master:6379/0'

  request-logging: true
  auth-logging: true
  standard-logging: true
  silence-ping-logging: true
</code></pre><p>Notes:</p>
<blockquote>
<ul>
<li>Ensure your callback URL does NOT have a trailing slash <code>/</code>.  This caused me some problems.</li>
<li>To create an app in Azure for OAuth2 Proxy to use, please follow their documentation here: <a href="https://oauth2-proxy.github.io/oauth2-proxy/auth-configuration#azure-auth-provider">Azure Auth provider</a></li>
<li>You&rsquo;ll notice the Redis connection config.  Please read <a href="https://oauth2-proxy.github.io/oauth2-proxy/configuration#configuring-for-use-with-the-nginx-auth_request-directive">this</a> section of the docs carefully, particularly if you&rsquo;re using Azure authentication.</li>
</ul>
</blockquote>
<p>The key is really the <code>set-xauthrequest</code> config.  As per the documentation:</p>
<blockquote>
<p>set X-Auth-Request-User, X-Auth-Request-Email and X-Auth-Request-Preferred-Username response headers (useful in Nginx auth_request mode)</p>
</blockquote>
<p>So when this is enabled, OAuth2 Proxy will return those 3 headers to the nginx subrequest, making their values available to nginx, rather than just returning an HTTP 2xx without them.</p>
<p>Is this specific case, we&rsquo;re after the <code>X-Auth-Request-Email</code> which is returned from Azure AD with the users email address, assuming successful authentication.</p>
<p>We then need to get that header value (<a href="mailto:some.users@example.com">some.users@example.com</a>) into the <code>es-security-runas-user</code> and pass that to the upstream Kibana instance.</p>
<p>Nginx Ingress Resources</p>
<pre><code>- apiVersion: extensions/v1beta1
  kind: Ingress
  metadata:
    name: kibana-ingress
    annotations:
      kubernetes.io/ingress.class: nginx
      nginx.ingress.kubernetes.io/auth-response-headers: X-Auth-Request-Email
      nginx.ingress.kubernetes.io/auth-url: &quot;https://$host/oauth2/auth&quot;
      nginx.ingress.kubernetes.io/auth-signin: &quot;https://$host/oauth2/start?rd=$escaped_request_uri&quot;

      nginx.ingress.kubernetes.io/configuration-snippet: |
        proxy_set_header 'es-security-runas-user' $authHeader0;
        proxy_set_header Authorization &quot;Basic &lt;your basic auth string&gt;&quot;;
  spec:
    rules:
    - host: kibana.example.com
      http:
        paths:
        - path: /
          backend:
            serviceName: kibana
            servicePort: 5601

- apiVersion: extensions/v1beta1
  kind: Ingress
  metadata:
    name: kibana-oauth2-ingress
    annotations:
      kubernetes.io/ingress.class: nginx
  spec:
    rules:
    - host: kibana.example.com
      http:
        paths:
        - path: /oauth2
          backend:
            serviceName: oauth2-proxy
            servicePort: 80
</code></pre><p>You&rsquo;ll notice there&rsquo;s actually 2 ingresses defined here, for the same hostname, but different paths.  I&rsquo;m not sure this is required, but it appears to be based on my testing.  If you attempt to use a single host, with separate paths for Kibana and OAuth2 Proxy it simply doesnt work.</p>
<p>In the Nginx Ingress configs, the important pieces are as follows.</p>
<h1 id="part-one">Part One</h1>
<blockquote>
<p>nginx.ingress.kubernetes.io/auth-url: &ldquo;https://$host/oauth2/auth&rdquo;
nginx.ingress.kubernetes.io/auth-signin: &ldquo;https://$host/oauth2/start?rd=$escaped_request_uri&rdquo;</p>
</blockquote>
<p>The <code>auth-url</code> and <code>auth-signin</code> annotations activate the <code>ngx_http_auth_request_module</code>, so that every request through this location ( <code>/</code> ) must be authenticated by the external source specified.  This source is <code>$host/oauth2</code>, which is the same hostname as kibana, but on the <code>oauth2</code> path, so its the second of the ingress resources specified above.</p>
<h1 id="part-two">Part Two</h1>
<blockquote>
<p>nginx.ingress.kubernetes.io/auth-response-headers: X-Auth-Request-Email</p>
</blockquote>
<p>The <code>auth-response-headers</code> annotation simply passes the <code>X-Auth-Request-Email</code> header that we received from Oauth2 Proxy onto the upstream, Kibana, assuming successful authentication.</p>
<p>Relevant documentation for the annotation:</p>
<blockquote>
<p>nginx.ingress.kubernetes.io/auth-response-headers: &lt;Response_Header_1, &hellip;, Response_Header_n&gt; to specify headers to pass to backend once authentication request completes.</p>
</blockquote>
<p>This by itself doesn&rsquo;t help much, as Kibana has no idea to do anything with that specific header, but the trick is that the ingress controller does this by setting an nginx var to the value of that header as returned by Oauth2 Proxy, and then setting the same header to be passed upstream using <code>proxy_set_header</code>.</p>
<p>Relevant nginx config snippet:</p>
<pre><code>auth_request_set $authHeader0 $upstream_http_x_auth_request_email;
proxy_set_header 'X-Auth-Request-Email' $authHeader0;
</code></pre><h1 id="part-three">Part Three</h1>
<blockquote>
<p>proxy_set_header &lsquo;es-security-runas-user&rsquo; $authHeader0;
proxy_set_header Authorization &ldquo;Basic <your basic auth string>&quot;;</p>
</blockquote>
<p>The important piece for Kibana authentication comes next, by re-using the nginx var <code>$authHeader0</code>, creating and setting the <code>es-security-runas-user</code> header using that var, and passing that upstream using <code>proxy_set_header</code>.</p>
<p>As long as Kibana receives the <code>es-security-runas-user</code> and the basic auth header <code>Authorization: Basic &lt;your basic auth string&gt;</code>, it will attempt to &ldquo;login&rdquo; using the value of the <code>es-security-runas-user</code> header.</p>
<p>In this case we&rsquo;re using emails as the username, but if your auth source provides a different value that OAuth2 Proxy can return to nginx, the same approach could be used.</p>
<p>Since this isintegrated with the Azure AD authentication flow, it can also take advantage of other authentication requirements, such as requiring MFA, or even Azure AD&rsquo;s Conditional Access system.  These sorts of features are available on most other auth providers I&rsquo;ve seen as well of course.</p>

        </div>
        

    


<div class="post-info">
    
        <div class="post-date dt-published">2020-08-06</div>
    
    
    <a class="post-hidden-url u-url" href="/posts/kibaba-oauth-kubernetes/">/posts/kibaba-oauth-kubernetes/</a>
    <a href="" class="p-name p-author post-hidden-author h-card" rel="me">Rob Rankin</a>


    <div class="post-taxonomies">
        
            <ul class="post-categories">
                
                    <li><a href="categories/">tech</a></li>
                
            </ul>
            
            
                <ul class="post-tags">
                    
                        <li><a href="tags/kubernetes">#kubernetes</a></li>
                    
                        <li><a href="tags/kibana">#kibana</a></li>
                    
                        <li><a href="tags/authentication">#authentication</a></li>
                    
                        <li><a href="tags/mfa">#mfa</a></li>
                    
                        <li><a href="tags/elasticsearch">#elasticsearch</a></li>
                    
                        <li><a href="tags/oauth2_proxy">#oauth2_proxy</a></li>
                    
                </ul>
        
    </div>
</div>

    </article>

    
        
    <div class="pagination post-pagination">
        <div class="left pagination-item ">
            
                <a href="/posts/querying-cylance-protect-api-from-shell/">Querying Cylance Protect Api From Shell</a>
            
        </div>
        <div class="right pagination-item ">
            
                <a href="/posts/puppet-module-for-foundationdb/">Puppet Module for FoundationDB</a>
            
        </div>
    </div>




    

    

    


        </main>
        
            <footer class="common-footer">
    
    

    <div class="common-footer-bottom">
        
        <div class="copyright">
            <p>© Rob Rankin, 2021<br>
            Powered by <a target="_blank" rel="noopener noreferrer" href="https://gohugo.io/">Hugo</a>, theme <a target="_blank" rel="noopener noreferrer" href="https://github.com/mitrichius/hugo-theme-anubis">Anubis</a>.<br>
            
            </p>  
        </div> 

        

    



    <button class="theme-switcher">
        Dark theme
    </button>

    <script>
    const STORAGE_KEY = 'user-color-scheme'
    const defaultTheme = "auto"

    let currentTheme
    let switchButton
    let autoDefinedScheme = window.matchMedia('(prefers-color-scheme: dark)')

    const autoChangeScheme = e => {
        currentTheme = e.matches ? 'dark' : 'light'
        document.documentElement.setAttribute('data-theme', currentTheme)
        changeButtonText()
    }

    document.addEventListener('DOMContentLoaded', function() {
        switchButton = document.querySelector('.theme-switcher')
        currentTheme = detectCurrentScheme()
        if (currentTheme == 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark')
        }
        if (currentTheme == 'auto') {
            autoChangeScheme(autoDefinedScheme);
            autoDefinedScheme.addListener(autoChangeScheme);
        }
        changeButtonText()
        switchButton.addEventListener('click', switchTheme, false)
    })

    function detectCurrentScheme() {
        if (localStorage.getItem(STORAGE_KEY)) {
            return localStorage.getItem(STORAGE_KEY)
        } 
        if (defaultTheme) {
            return defaultTheme
        } 
        if (!window.matchMedia) {
            return 'light'
        } 
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            return 'dark'
        }
        return 'light'
    }

    function changeButtonText()
    {   
        switchButton.textContent = currentTheme == 'dark' ?  "Light theme" : "Dark theme"
    }

    function switchTheme(e) {
        if (currentTheme == 'dark') {
            localStorage.setItem(STORAGE_KEY, 'light')
            document.documentElement.setAttribute('data-theme', 'light')
            currentTheme = 'light'
        } else {
            localStorage.setItem(STORAGE_KEY, 'dark')
            document.documentElement.setAttribute('data-theme', 'dark')
            currentTheme = 'dark'
        }
        changeButtonText()
    }
    </script>
   
    </div>

    <p class="h-card vcard">

    <a href= class="p-name u-url url fn" rel="me">Rob Rankin</a> 

     
        /
        <a class="p-email u-email email" rel="me" href="mailto:blob@undertow.ca">blob@undertow.ca</a>
    

     
        <img class="u-photo" src="/images/me.png" />
    
</p> 
</footer>

        
    </div>
</body>
</html>
