<!DOCTYPE html>


<html lang="en-us" data-theme="">
<head>
    
        
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer-when-downgrade">

<title>Event Threat Enrichment using Logstash and Minemeld - Home</title>
<meta name="description" content="">

<link rel="icon" type="image/x-icon" href="favicon.ico">
<link rel="apple-touch-icon-precomposed" href="favicon.png">



    





    
    
    

    
        <link rel="stylesheet" href="/css/style.4622e864a3694db065c6fdee8f297dc58db0efa3a22c934e5b0863569db3def4.css" integrity="sha256-RiLoZKNpTbBlxv3ujyl9xY2w76OiLJNOWwhjVp2z3vQ=">
    





<meta property="og:title" content="Event Threat Enrichment using Logstash and Minemeld" />
<meta property="og:description" content="At my work we use the Elastic Stack for quite a few things, but one of the more recent-ish &ldquo;official&rdquo; roles is as our SIEM. Elastic introduced SIEM specific funcationality to Kibana a few releases ago, around 7.4 if I rembember correctly.
One of the features that the Elastic Stack doesn&rsquo;t really support well (yet) is an enrichment system. They did introduce an elasticsearch side enrichment system in 7.5, but in my opinionn theres a few problems with it:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/event-threat-enrichment-logstash-minemeld/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-09-25T09:22:36+01:00" />
<meta property="article:modified_time" content="2020-09-25T09:22:36+01:00" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Event Threat Enrichment using Logstash and Minemeld"/>
<meta name="twitter:description" content="At my work we use the Elastic Stack for quite a few things, but one of the more recent-ish &ldquo;official&rdquo; roles is as our SIEM. Elastic introduced SIEM specific funcationality to Kibana a few releases ago, around 7.4 if I rembember correctly.
One of the features that the Elastic Stack doesn&rsquo;t really support well (yet) is an enrichment system. They did introduce an elasticsearch side enrichment system in 7.5, but in my opinionn theres a few problems with it:"/>



    
        <link rel="webmention" href="https://webmention.io/hugo-theme-anubis/webmention" />
        
            <link rel="pingback" href="https://webmention.io/hugo-theme-anubis/xmlrpc" />
        
    
    
        <link rel="webmention" href="https://yourdomain.com/webemntions/receive" />
    






    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MYJYFQEBD7"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-MYJYFQEBD7', { 'anonymize_ip': false });
}
</script>





    
</head>
<body>
    <a class="skip-main" href="#main">Skip to main content</a>
    <div class="container">
        <header class="common-header"> 
            
                <div class="header-top">
    <h1 class="site-title">
        <a href="/">Home</a>
    </h1>
    <ul class="social-icons">


    
        
        
        <li>
            <a href="https://github.com/robrankin" title="Github" rel="me">
            <span class="inline-svg" >
    



    
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!-- Font Awesome Free 5.15.3 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

</span>

            </a>
        </li>
    

    
        
        
        <li>
            <a href="https://twitter.com/mahhyzero" title="Twitter" rel="me">
            <span class="inline-svg" >
    



    
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.3 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>

</span>

            </a>
        </li>
    

    
        
        
        <li>
            <a href="https://www.linkedin.com/in/rob-rankin-7312234" title="Linkedin" rel="me">
            <span class="inline-svg" >
    



    
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.3 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

</span>

            </a>
        </li>
    

    
        
        
        <li>
            <a href="mailto:blog@undertow.ca" title="Email" rel="me">
            <span class="inline-svg" >
    



    
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.3 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path fill="currentColor" d="M464 64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 400V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V400H48z"/></svg>

</span>

            </a>
        </li>
    

</ul>

</div>

    <nav></nav>




            
        </header>
        <main id="main" tabindex="-1"> 
            
    
    
    <article class="post h-entry">
        <header class="post-header">
            <h1 class="p-name post-title">Event Threat Enrichment using Logstash and Minemeld</h1>

            
        </header>
        <div class="content e-content">
            <p>At my work we use the Elastic Stack for quite a few things, but one of the more recent-ish &ldquo;official&rdquo; roles is as our SIEM.  Elastic introduced SIEM specific funcationality to Kibana a few releases ago, around 7.4 if I rembember correctly.</p>
<p>One of the features that the Elastic Stack doesn&rsquo;t really support well (yet) is an enrichment system.  They did introduce an elasticsearch side <a href="https://www.elastic.co/blog/introducing-the-enrich-processor-for-elasticsearch-ingest-nodes">enrichment system</a> in 7.5, but in my opinionn theres a few problems with it:</p>
<ul>
<li>It runs inside ElasticSeach using ES pipelines, which are harder to design and operate than something Logstash side, as wellas not quite being as flexible I&rsquo;d like.</li>
<li>As it runs in ES ingest nodes, it has a license cost impact</li>
<li>The processors available have some limitations, such as no support for range queries currently, which is important in the use case I&rsquo;ll be writing about here.</li>
</ul>
<p>One of the requirements I have for our SIEM is to be able to identify events coming from &ldquo;known risky IPs&rdquo;.  Those risky IPs could be known botnets, spam sources, tor exit nodes, or anything else that you or threat intelligence providers/feeds classify as a risk.</p>
<p>After much research I settled on the approach I&rsquo;ll detail below.</p>
<p>First I needed a way of collecting threat feeds in such a way that they&rsquo;d be useable by the SIEM.  For this I settled on using <a href="https://www.paloaltonetworks.com/products/secure-the-network/subscriptions/minemeld">Minemeld</a>, a product by Palo Alto networks, as they describe it &ldquo;an open-source application that streamlines the aggregation, enforcement and sharing of threat intelligence&rdquo;.</p>
<p>There are quite a few other options for this, but Minemeld seemed ideal for me because:</p>
<ul>
<li>It&rsquo;s a pretty focused design, where some other options are far far more than just threat feed aggregation.</li>
<li>It&rsquo;s pretty simple to use and setup</li>
<li>It has support for delivering threat feed data to Logstash</li>
</ul>
<h1 id="minemeld">Minemeld</h1>
<blockquote>
<p>Note
This post only deals with IoCs of &ldquo;IP type&rdquo;.  Minemeld can consume, aggregate, and distribute IoCs of other tyes, such as URLs, domains, etc, but they are not dealt with by this article.</p>
</blockquote>
<p>How to install, run and configure feeds/aggregators/etc in Minemeld is an exercise left to the reader.</p>
<p>To enable Logstash output, you can use the built in prototype <code>stdlib.localLogStash</code>, if your logstash instance is running on the same system as Minemeld and is reachable over localhost:</p>
<p><img src="/images/234a165e8b86498c8956617b0d01e6ca.png" alt="234a165e8b86498c8956617b0d01e6ca.png"></p>
<p>However in my case, my logstash instances arent runnin on the same host, and in fact I have multiple target instances.</p>
<p>In a case like this, you need to create a new prototype by pressing the &ldquo;New&rdquo; button highlighted in the above screenshot.</p>
<p>Set your new &ldquo;local prototype&rdquo; name, and then the important part, set the <code>logstash_host:</code> config field:</p>
<p><img src="/images/465f6543348749ac96240d6db28031b0.png" alt="465f6543348749ac96240d6db28031b0.png"></p>
<p>Hit save, and thats it.  You now have a method of outputting IoCs from various IP threat feeds to Logstash.  I&rsquo;ve done this two times, with different <code>logstash_host:</code> set for each new local prototype.  So I&rsquo;m duplicating my IoCs to two different logstash and elasticsearch clusters.</p>
<h1 id="logstash---part-1">Logstash - Part 1</h1>
<blockquote>
<p>Important Note:
You will need to define an index template/mapping that ensures the start and end IP address fields created by the dissect filter below are actually of IP datatype.  IP Range queries used in Part 2 will not work without this.</p>
</blockquote>
<p>On the logstash side the configs for reading and storing the Minemeld provided IoCs are reasonably simple.</p>
<p>Part 2 will look at how I do event enrichment.</p>
<p>First, you need to listen on the TCP input port configured in your Minemeld local prototypes, in the case above:</p>
<pre><code>input {
  tcp {
    port =&gt; 5514
  }
}
</code></pre><p>You then need some filters to parse the message field, create a predictable document ID, and split the <code>@indicator</code> into a start and end IP address, which will be used for ES range queries in Part 2.</p>
<pre><code>filter {
  # Parse the message field as JSON into the target minemeld field
  json {
    source =&gt; &quot;message&quot;
    target =&gt; &quot;minemeld&quot;
  }
  
  # Generate a fingerprint on the @indicator field, this will be used as the Document ID in the Elasticsearch outputs.
  fingerprint {
    source =&gt; &quot;[minemeld][@indicator]&quot;
    target =&gt; &quot;[@metadata][fingerprint]&quot;
    method =&gt; &quot;MURMUR3&quot;
  }

  # Split the IP indicator field on the -, so we have a start and end IP address
  dissect {
    mapping =&gt; { &quot;[minemeld][@indicator]&quot; =&gt; &quot;%{[minemeld][indicator][ip][start]}-%{[minemeld][indicator][ip][end]}&quot; }
  }

}
</code></pre><p>So now you just need to store that docuement in an ES index.  The slightly different part, as compared to for example storing log data in ES, is that IoCs can and will &ldquo;expire&rdquo;, and therefore need to be removed from the index when that happens.</p>
<p>Minemeld caters for this by providing a &ldquo;message&rdquo;, and if the value of that message is &ldquo;withdraw&rdquo;, the IoC can be removed.  As can be seen in the Logstash output configs below, when we receive an event with <code>[minemeld][message] == &quot;withdraw&quot;</code> we issue a delete against the ES index, as indicated by <code>action =&gt; &quot;delete&quot;</code>.  This uses the predictable document ID we create in the earlier filter, so we know which document to delete.</p>
<p>Also note the index template specified in the configs, and refer to the note at the start of this section.</p>
<pre><code>output {
    if [minemeld][message] == &quot;withdraw&quot; {
      elasticsearch {
        hosts =&gt; [
          &quot;http://&lt;es&gt;&quot;
        ]
        index =&gt; &quot;minemeld&quot;
        manage_template =&gt; true
        template_name =&gt; &quot;minemeld&quot;
        template =&gt; &quot;/etc/logstash/minemeld.indextemplate&quot;
        document_id =&gt; &quot;%{[@metadata][fingerprint]}&quot;
        action =&gt; &quot;delete&quot;
      }
    } else {
      elasticsearch {
        hosts =&gt; [
          &quot;http://&lt;es&gt;&quot;
        ]
        index =&gt; &quot;minemeld&quot;
        manage_template =&gt; true
        template_name =&gt; &quot;minemeld&quot;
        template =&gt; &quot;/etc/logstash/minemeld.indextemplate&quot;
        document_id =&gt; &quot;%{[@metadata][fingerprint]}&quot;
      }
    }
}
</code></pre><p>So at this point you should have some Minemeld provided IoCs stored in an Elasticsearch index, which can be used to enrich other events in real time.</p>
<h1 id="logstash---part-2">Logstash - Part 2</h1>
<p>So now onto how to enrich events.  In my case, certain events come with a <code>source.ip</code> address, and I then do a ES lookup using the Logstash elasticsearch <em>filter</em>.</p>
<pre><code>filter {
      elasticsearch {
          hosts =&gt; [
            &quot;http://&lt;es&gt;/&quot;
          ]
        index =&gt; &quot;minemeld&quot;
        enable_sort =&gt; &quot;false&quot;
        tag_on_failure =&gt; [ &quot;_threat_lookup_failure&quot; ]
        add_tag =&gt; [&quot;_threat_found&quot;]
        query_template =&gt; &quot;/etc/logstash/conf.d/threat_query.json&quot;
        fields =&gt; {
          &quot;[minemeld][sources]&quot; =&gt; &quot;[custom][threat][sources]&quot;
        }
      }
}
</code></pre><p>The query, specified in <code>query_template =&gt; &quot;/etc/logstash/conf.d/threat_query.json&quot;</code> is as follows:</p>
<pre><code>{
  &quot;query&quot;: {
    &quot;bool&quot;: {
      &quot;filter&quot;: [
        { &quot;range&quot;: { &quot;minemeld.indicator.ip.start&quot;: { &quot;lte&quot;: &quot;%{[source][ip]}&quot; }}},
        { &quot;range&quot;: { &quot;minemeld.indicator.ip.end&quot;: { &quot;gte&quot;: &quot;%{[source][ip]}&quot; }}}
      ]
    }
  }
}
</code></pre><blockquote>
<p>Note
This is where you need to ensure you&rsquo;ve created these fields as IP datatypes, as mentioned previously.</p>
</blockquote>
<p>All this does is excute the above query against the Minemeld ES index, and looks for a match where the Minemeld <code>minemeld.indicator.ip.start</code> is less than or equal to, and the <code>minemeld.indicator.ip.end</code> is greater than or equal to the source IP in the event that we&rsquo;re attempting to enrich.</p>
<p>Basically: &ldquo;if the source IP is between the start and end range provided by Minemeld&rdquo;.</p>
<p>The actual enrichment is performed by the <code>fields</code> parameter of the <code>elasticsearch</code> filter.  In the example above, it sets a field <code>custom.threat.sources</code> to the value of <code>minemeld.sources</code> from the document in the Minemeld index, which is a list of source &ldquo;names&rdquo; provided by minemeld.</p>
<h1 id="conclusion">Conclusion</h1>
<p>That&rsquo;s it.  We now have an indication if a source IP in an event is considered a threat by various threat feeds, which is obviously very useful for informing any decisions around responses.</p>
<p>Some closing thoughts.</p>
<p>Performance.  This approach is almost definitely not scalable to extremely high throughput levels, due to the overhead of network connections between logstash and elasticsearch, and the impact of querying elasticsearch for every event.  It would be signficantly better tyo take advantage of Logstashs' translate filter or its memcache filter.</p>
<p>However, both the dictionary and memcache filter suffer from the same limitation: theres no (easy?) way of doing range type queries.</p>
<p>As I mentioned earlier, Elasticsearchs new enrichment pipeline features also doesnt support range queries, at this time.</p>
<p>Since the Minemeld threat feeds provide IP ranges, the only options are:</p>
<ul>
<li>Use a queryable source that supports range queries on IP addresses (or their integer representation thereof)</li>
<li>Expand the Minemeld provided IP ranges into lists of singlular IPs.</li>
</ul>
<p>I actually experimented with option two, expanding the Minemeld ranges into complete lists of single /32 IPs. Depending on the number of the threat feeds being consumed and their size, you will end up with millions and millions of IP addresses in your new list, which may not be usable in logstash dictionaries or memcache.  YMMV.</p>
<p>At the time I decided to continue using the Elasticsearch IP range query approach for now, as the number of events I&rsquo;m enriching is low enough to not impact our performance or availability.  However in the future I&rsquo;m going to want to apply this kind of enrichment against a much larger amount of events, so I&rsquo;m going to have to revisit the approach I think.</p>

        </div>
        

    


<div class="post-info">
    
        <div class="post-date dt-published">2020-09-25</div>
    
    
    <a class="post-hidden-url u-url" href="/posts/event-threat-enrichment-logstash-minemeld/">/posts/event-threat-enrichment-logstash-minemeld/</a>
    <a href="" class="p-name p-author post-hidden-author h-card" rel="me">Rob Rankin</a>


    <div class="post-taxonomies">
        
            <ul class="post-categories">
                
                    <li><a href="categories/">tech</a></li>
                
            </ul>
            
            
                <ul class="post-tags">
                    
                        <li><a href="tags/minemeld">#minemeld</a></li>
                    
                        <li><a href="tags/logstash">#logstash</a></li>
                    
                        <li><a href="tags/threat-feeds">#threat feeds</a></li>
                    
                        <li><a href="tags/security">#security</a></li>
                    
                        <li><a href="tags/elasticsearch">#elasticsearch</a></li>
                    
                        <li><a href="tags/kibana">#kibana</a></li>
                    
                </ul>
        
    </div>
</div>

    </article>

    
        
    <div class="pagination post-pagination">
        <div class="left pagination-item ">
            
                <a href="/posts/using-elasticsearch-upserts-to-combine-multiple-event-lines-into-one/">Using Elasticsearch Upserts to Combine Multiple Event Lines Into One</a>
            
        </div>
        <div class="right pagination-item ">
            
                <a href="/posts/querying-cylance-protect-api-from-shell/">Querying Cylance Protect Api From Shell</a>
            
        </div>
    </div>




    

    

    


        </main>
        
            <footer class="common-footer">
    
    

    <div class="common-footer-bottom">
        
        <div class="copyright">
            <p>© Rob Rankin, 2021<br>
            Powered by <a target="_blank" rel="noopener noreferrer" href="https://gohugo.io/">Hugo</a>, theme <a target="_blank" rel="noopener noreferrer" href="https://github.com/mitrichius/hugo-theme-anubis">Anubis</a>.<br>
            
            </p>  
        </div> 

        

    


   
    </div>

    <p class="h-card vcard">

    <a href= class="p-name u-url url fn" rel="me">Rob Rankin</a> 

     
        /
        <a class="p-email u-email email" rel="me" href="mailto:mail@example.org">mail@example.org</a>
    

     
        <img class="u-photo" src="/images/me.png" />
    
</p> 
</footer>

        
    </div>
</body>
</html>
