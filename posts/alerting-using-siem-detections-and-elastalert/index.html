<!DOCTYPE html>


<html lang="en-us" data-theme="">
<head>
    
        
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer-when-downgrade">

<title>Alerting using SIEM Detections and ElastAlert - Home</title>
<meta name="description" content="">

<link rel="icon" type="image/x-icon" href="favicon.ico">
<link rel="apple-touch-icon-precomposed" href="favicon.png">



    





    
    
    

    
        <link rel="stylesheet" href="/css/style.4622e864a3694db065c6fdee8f297dc58db0efa3a22c934e5b0863569db3def4.css" integrity="sha256-RiLoZKNpTbBlxv3ujyl9xY2w76OiLJNOWwhjVp2z3vQ=">
    





<meta property="og:title" content="Alerting using SIEM Detections and ElastAlert" />
<meta property="og:description" content="ElasticSearch SIEM Detections and Alerts and Actions are quite useful features, except for the fact that actual alerting is behind a license paywall. So while both of these features can run rules, check for conditions, and record the results in an index, neither of them actually provide alerting support.
Alerting requires a Gold License, which if alerting is the only thing you want, is an excessive cost.
If you can&rsquo;t move off ElasticSearch to OpenSearch, which has Alerting available for free, you can use tools such as ElastAlert21 to handle the Alerting requirements." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/alerting-using-siem-detections-and-elastalert/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-17T08:32:41+01:00" />
<meta property="article:modified_time" content="2021-08-17T08:32:41+01:00" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Alerting using SIEM Detections and ElastAlert"/>
<meta name="twitter:description" content="ElasticSearch SIEM Detections and Alerts and Actions are quite useful features, except for the fact that actual alerting is behind a license paywall. So while both of these features can run rules, check for conditions, and record the results in an index, neither of them actually provide alerting support.
Alerting requires a Gold License, which if alerting is the only thing you want, is an excessive cost.
If you can&rsquo;t move off ElasticSearch to OpenSearch, which has Alerting available for free, you can use tools such as ElastAlert21 to handle the Alerting requirements."/>



    
        <link rel="webmention" href="https://webmention.io/hugo-theme-anubis/webmention" />
        
            <link rel="pingback" href="https://webmention.io/hugo-theme-anubis/xmlrpc" />
        
    
    
        <link rel="webmention" href="https://yourdomain.com/webemntions/receive" />
    






    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MYJYFQEBD7"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-MYJYFQEBD7', { 'anonymize_ip': false });
}
</script>





    
</head>
<body>
    <a class="skip-main" href="#main">Skip to main content</a>
    <div class="container">
        <header class="common-header"> 
            
                <div class="header-top">
    <h1 class="site-title">
        <a href="/">Home</a>
    </h1>
    <ul class="social-icons">


    
        
        
        <li>
            <a href="https://github.com/robrankin" title="Github" rel="me">
            <span class="inline-svg" >
    



    
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!-- Font Awesome Free 5.15.3 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

</span>

            </a>
        </li>
    

    
        
        
        <li>
            <a href="https://twitter.com/mahhyzero" title="Twitter" rel="me">
            <span class="inline-svg" >
    



    
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.3 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>

</span>

            </a>
        </li>
    

    
        
        
        <li>
            <a href="https://www.linkedin.com/in/rob-rankin-7312234" title="Linkedin" rel="me">
            <span class="inline-svg" >
    



    
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.3 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

</span>

            </a>
        </li>
    

    
        
        
        <li>
            <a href="mailto:blog@undertow.ca" title="Email" rel="me">
            <span class="inline-svg" >
    



    
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.3 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path fill="currentColor" d="M464 64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 400V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V400H48z"/></svg>

</span>

            </a>
        </li>
    

</ul>

</div>

    <nav></nav>




            
        </header>
        <main id="main" tabindex="-1"> 
            
    
    
    <article class="post h-entry">
        <header class="post-header">
            <h1 class="p-name post-title">Alerting using SIEM Detections and ElastAlert</h1>

            
        </header>
        <div class="content e-content">
            <p>ElasticSearch SIEM Detections and Alerts and Actions are quite useful features, except for the fact that actual alerting is behind a license paywall.  So while both of these features can run rules, check for conditions, and record the results in an index, neither of them actually provide <em>alerting</em> support.</p>
<p>Alerting requires a Gold License, which if alerting is the only thing you want, is an excessive cost.</p>
<p>If you can&rsquo;t move off ElasticSearch to <a href="https://opensearch.org/">OpenSearch</a>, which has Alerting available for free, you can use tools such as <a href="https://github.com/jertel/elastalert2">ElastAlert2</a><sup>1</sup> to handle the Alerting requirements.</p>
<h1 id="siem-detections">SIEM Detections</h1>
<p>The following example is for SIEM Detections, and alerting with ElastAlert2.</p>
<p>SIEM Detections record their results in an index called <code>.siem-signals-default</code>.  The <code>-default</code> part is based on the Kibana space, so if you&rsquo;re using a Kibana space called <code>exampleA</code>, the index name would be <code>.siem-signals-examplea</code>.</p>
<p>Make sure to create a Kibana Index Pattern for this index, so you can explore it fully.</p>
<p>The key field to be aware of is the <code>signal.rule.name</code>, which is of course the SIEM Detection Rule name.  This is what we&rsquo;ll use to create an ElastAlert rule.</p>
<p>You&rsquo;ll want to check what kind of ElastAlert rule you want to create, which you can find <a href="https://elastalert2.readthedocs.io/en/latest/ruletypes.html#rule-types">here ( https://elastalert2.readthedocs.io/en/latest/ruletypes.html#rule-types )</a>.</p>
<p>For many of our SIEM Detection rules we use the ElastAlert <code>any</code> rule type.  According to the ElastAlert documentation:</p>
<blockquote>
<p>The any rule will match everything. Every hit that the query returns will generate an alert.</p>
</blockquote>
<p>In many cases this will not be what you want as it could generate a lot of noise, but in the case of SIEM Detections, if they&rsquo;re tuned well, hopefully they won&rsquo;t be generating hundreds of records that this ElastAlert rule would be alerting on.</p>
<p>Below is an example ElastAlert rule that alerts us when there are Azure Subscription level IAM changes (as detected by a SIEM Detection rule).</p>
<pre><code>name: Azure Subscription IAM Change

index: .siem-signals-default-*

filter:
- query:
    query_string:
      query: 'signal.rule.name: &quot;Azure Subscription IAM Change&quot; AND event.outcome: *'

type: any

realert:
  minutes: 0

alert:
- &quot;slack&quot;

alert_subject: &quot;Azure Subscription IAM Change&quot;

alert_text: &quot;
{0}\n
Grantor:\n
User Name: {1}\n
Application Name: {2}\n
Application ID: {3}\n
\n
Grantee:\n
Principal Name: {4}\n
Principal ID: {5}\n
Principal Type: {6}\n
Role Name: {7}\n
Role ID: {8}\n
Subscription Name: {9}\n
Subscription ID: {10}\n
\n&quot;

alert_missing_value: &quot;N/A&quot;

alert_text_args:
- &quot;signal.rule.name&quot;
- &quot;user.name&quot;
- &quot;aad.application.name&quot;
- &quot;aad.application.id&quot;
- &quot;azure.iam.principal.name&quot;
- &quot;azure.iam.principal.id&quot;
- &quot;azure.iam.principal.type&quot;
- &quot;azure.iam.role.name&quot;
- &quot;azure.iam.role.id&quot;
- &quot;azure.subscription.name&quot;
- &quot;azure.subscription.id&quot;

alert_text_type: alert_text_only
</code></pre><blockquote>
<p>Note: ElastAlert uses the older Lucene query syntax, whereas modern Kibana uses Kibana Query Language (KQL) by default.  Make sure to switch to using Lucene in Kibana when exploring or writing searches for use with ElastAlert.</p>
</blockquote>
<p>ElastAlert has an extensive set of possible alert targets, in the example I&rsquo;m using Slack, but a few of the other common ones I use are:</p>
<ul>
<li>HTTP POST</li>
<li>Command</li>
<li>Alerta (quite useful alert dashboard)</li>
<li>Email</li>
<li>Jira</li>
</ul>
<p>The full list can be found here: <a href="https://elastalert2.readthedocs.io/en/latest/ruletypes.html#alerts">ElastAlert Alerters</a></p>
<h1 id="notes">Notes</h1>
<ol>
<li>ElastAlert2 is the community fork of the original Yelp created ElastAlert which they abandoned a year or two ago, without any real effort to hand over to anyone to maintain.</li>
</ol>

        </div>
        

    


<div class="post-info">
    
        <div class="post-date dt-published">2021-08-17</div>
    
    
    <a class="post-hidden-url u-url" href="/posts/alerting-using-siem-detections-and-elastalert/">/posts/alerting-using-siem-detections-and-elastalert/</a>
    <a href="" class="p-name p-author post-hidden-author h-card" rel="me">Rob Rankin</a>


    <div class="post-taxonomies">
        
            <ul class="post-categories">
                
                    <li><a href="categories/">tech</a></li>
                
            </ul>
            
            
                <ul class="post-tags">
                    
                        <li><a href="tags/elasticsearch">#elasticsearch</a></li>
                    
                        <li><a href="tags/opensearch">#opensearch</a></li>
                    
                        <li><a href="tags/elastalert">#elastalert</a></li>
                    
                        <li><a href="tags/elastalert2">#elastalert2</a></li>
                    
                        <li><a href="tags/alerting">#alerting</a></li>
                    
                </ul>
        
    </div>
</div>

    </article>

    
        
    <div class="pagination post-pagination">
        <div class="left pagination-item ">
            
                <a href="/posts/modsecurity-detectiononly-and-enforcing-select-rules/">Modsecurity, DetectionOnly and enforcing select rules</a>
            
        </div>
        <div class="right pagination-item ">
            
                <a href="/posts/using-elasticsearch-upserts-to-combine-multiple-event-lines-into-one/">Using Elasticsearch Upserts to Combine Multiple Event Lines Into One</a>
            
        </div>
    </div>




    

    

    


        </main>
        
            <footer class="common-footer">
    
    

    <div class="common-footer-bottom">
        
        <div class="copyright">
            <p>Â© Rob Rankin, 2021<br>
            Powered by <a target="_blank" rel="noopener noreferrer" href="https://gohugo.io/">Hugo</a>, theme <a target="_blank" rel="noopener noreferrer" href="https://github.com/mitrichius/hugo-theme-anubis">Anubis</a>.<br>
            
            </p>  
        </div> 

        

    



    <button class="theme-switcher">
        Dark theme
    </button>

    <script>
    const STORAGE_KEY = 'user-color-scheme'
    const defaultTheme = "auto"

    let currentTheme
    let switchButton
    let autoDefinedScheme = window.matchMedia('(prefers-color-scheme: dark)')

    const autoChangeScheme = e => {
        currentTheme = e.matches ? 'dark' : 'light'
        document.documentElement.setAttribute('data-theme', currentTheme)
        changeButtonText()
    }

    document.addEventListener('DOMContentLoaded', function() {
        switchButton = document.querySelector('.theme-switcher')
        currentTheme = detectCurrentScheme()
        if (currentTheme == 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark')
        }
        if (currentTheme == 'auto') {
            autoChangeScheme(autoDefinedScheme);
            autoDefinedScheme.addListener(autoChangeScheme);
        }
        changeButtonText()
        switchButton.addEventListener('click', switchTheme, false)
    })

    function detectCurrentScheme() {
        if (localStorage.getItem(STORAGE_KEY)) {
            return localStorage.getItem(STORAGE_KEY)
        } 
        if (defaultTheme) {
            return defaultTheme
        } 
        if (!window.matchMedia) {
            return 'light'
        } 
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            return 'dark'
        }
        return 'light'
    }

    function changeButtonText()
    {   
        switchButton.textContent = currentTheme == 'dark' ?  "Light theme" : "Dark theme"
    }

    function switchTheme(e) {
        if (currentTheme == 'dark') {
            localStorage.setItem(STORAGE_KEY, 'light')
            document.documentElement.setAttribute('data-theme', 'light')
            currentTheme = 'light'
        } else {
            localStorage.setItem(STORAGE_KEY, 'dark')
            document.documentElement.setAttribute('data-theme', 'dark')
            currentTheme = 'dark'
        }
        changeButtonText()
    }
    </script>
   
    </div>

    <p class="h-card vcard">

    <a href= class="p-name u-url url fn" rel="me">Rob Rankin</a> 

     
        /
        <a class="p-email u-email email" rel="me" href="mailto:blob@undertow.ca">blob@undertow.ca</a>
    

     
        <img class="u-photo" src="/images/me.png" />
    
</p> 
</footer>

        
    </div>
</body>
</html>
